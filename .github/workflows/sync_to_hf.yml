name: Sync to Hugging Face Hub

on:
  push:
    branches: [main] # ç•¶ main åˆ†æ”¯æœ‰æ›´æ–°æ™‚è§¸ç™¼
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      HF_SPACE: cwbdayi/EEW_quality_control
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Push to hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # 1. ç¢ºä¿ LFS å·²åˆå§‹åŒ– (å¦‚æœä½ æœ‰å¤§å‹æª”æ¡ˆ)
          git lfs install
          
          # 2. ä½¿ç”¨ git credential store å®‰å…¨å‚³é Tokenï¼Œé¿å… Token æ´©æ¼åˆ°æ—¥èªŒæˆ–ç¨‹åºåˆ—è¡¨ä¸­
          CREDENTIALS_FILE=$(mktemp)
          trap 'rm -f "$CREDENTIALS_FILE"' EXIT
          chmod 600 "$CREDENTIALS_FILE"
          echo "https://cwbdayi:${HF_TOKEN}@huggingface.co" > "$CREDENTIALS_FILE"
          git config credential.helper "store --file=$CREDENTIALS_FILE"
          
          HF_REPO_URL="https://huggingface.co/spaces/cwbdayi/EEW_quality_control"
          git remote add hf "$HF_REPO_URL" 2>/dev/null || \
            git remote set-url hf "$HF_REPO_URL"
          
          # 3. å¼·åˆ¶æ¨é€
          # ä½¿ç”¨ --force å¯ä»¥è§£æ±º (stale info) æˆ– (fetch first) çš„è¡çªå•é¡Œ
          git push --force hf main

      - name: Wait for HF Space deployment
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          API_URL="https://huggingface.co/api/spaces/${HF_SPACE}"

          echo "ç­‰å¾… Hugging Face Space éƒ¨ç½²å®Œæˆ..."

          MAX_ATTEMPTS=60
          SLEEP_SECONDS=10
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            RESPONSE=$(curl -s -H "Authorization: Bearer $HF_TOKEN" "${API_URL}/runtime")
            STAGE=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('stage','UNKNOWN'))" 2>/dev/null)
            if [ -z "$STAGE" ]; then
              echo "âš ï¸ ç„¡æ³•è§£æ API å›æ‡‰: ${RESPONSE}"
              STAGE="UNKNOWN"
            fi

            echo "å˜—è©¦ ${ATTEMPT}/${MAX_ATTEMPTS}: ç›®å‰ç‹€æ…‹ = ${STAGE}"

            if [ "$STAGE" = "RUNNING" ]; then
              echo "âœ… Space éƒ¨ç½²å®Œæˆï¼Œç‹€æ…‹: RUNNING"
              break
            elif [ "$STAGE" = "RUNTIME_ERROR" ] || [ "$STAGE" = "BUILD_ERROR" ]; then
              echo "âŒ Space éƒ¨ç½²å¤±æ•—ï¼Œç‹€æ…‹: ${STAGE}"
              break
            fi

            sleep $SLEEP_SECONDS
          done

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ] && [ "$STAGE" != "RUNNING" ]; then
            echo "âš ï¸ è¶…éæœ€å¤§ç­‰å¾…æ™‚é–“ï¼Œç›®å‰ç‹€æ…‹: ${STAGE}"
          fi

      - name: Fetch HF deployment logs
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          LOG_DIR="hf_deploy_logs"
          TIMESTAMP=$(date -u '+%Y%m%d_%H%M%S')

          mkdir -p "$LOG_DIR"

          echo "ğŸ“¥ æŠ“å– Hugging Face Space å»ºæ§‹æ—¥èªŒ..."

          # æŠ“å– build logs (éƒ¨ç½²éç¨‹æ—¥èªŒ)
          if ! curl -s -N \
            -H "Authorization: Bearer $HF_TOKEN" \
            "https://huggingface.co/api/spaces/${HF_SPACE}/logs/build" \
            > "${LOG_DIR}/build_${TIMESTAMP}.txt" 2>&1; then
            echo "âš ï¸ æŠ“å– build logs å¤±æ•—"
          fi

          # æŠ“å– run logs (åŸ·è¡Œæ—¥èªŒ)
          # ä½¿ç”¨ timeout é¿å…ä¸²æµé€£ç·šç„¡é™ç­‰å¾…
          if ! timeout 30 curl -s -N \
            -H "Authorization: Bearer $HF_TOKEN" \
            "https://huggingface.co/api/spaces/${HF_SPACE}/logs/run" \
            > "${LOG_DIR}/run_${TIMESTAMP}.txt" 2>&1; then
            echo "âš ï¸ æŠ“å– run logs å¤±æ•—æˆ–é€¾æ™‚"
          fi

          echo "ğŸ“„ æ—¥èªŒå·²å„²å­˜è‡³ ${LOG_DIR}/"
          ls -la "$LOG_DIR/"

      - name: Commit and push logs to GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add hf_deploy_logs/

          # æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„è®Šæ›´éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "æ²’æœ‰æ–°çš„æ—¥èªŒè®Šæ›´éœ€è¦æäº¤"
          else
            git commit -m "[skip ci] ğŸ“‹ æ–°å¢ HF Space éƒ¨ç½²æ—¥èªŒ ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))"
            git push origin main
            echo "âœ… æ—¥èªŒå·²æ¨é€åˆ° GitHub"
          fi
