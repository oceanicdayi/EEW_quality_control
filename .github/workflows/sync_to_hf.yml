# å·¥ä½œæµç¨‹åç¨±ï¼šåŒæ­¥åˆ° Hugging Face Hub ä¸¦ç›£æ§éƒ¨ç½²
name: Sync to Hugging Face Hub (Optimized with Email)

on:
  push:
    branches: [main] # ç•¶ main åˆ†æ”¯æœ‰æ›´æ–°æ™‚è§¸ç™¼
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
  schedule:
    - cron: '0 */6 * * *' # æ¯ 6 å°æ™‚æª¢æŸ¥ä¸€æ¬¡ HF æ˜¯å¦æœ‰æ›´æ–°

# é˜²æ­¢å¤šå€‹å·¥ä½œæµåŒæ™‚è·‘ï¼Œå°è‡´ Git è¡çª
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è™›æ“¬æ©Ÿ
    permissions:
      contents: write # è³¦äºˆå¯«å…¥æ¬Šé™ä»¥ä¾¿æ¨é€åˆ° GitHub
    env:
      HF_SPACE: cwbdayi/EEW_quality_control # å®šç¾© HF Space è·¯å¾‘
      HF_USERNAME: cwbdayi # å®šç¾© HF ç”¨æˆ¶å

    steps:
      # æ­¥é©Ÿ 1ï¼šä¸‹è¼‰å„²å­˜åº«å…§å®¹
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å–å¾—å®Œæ•´æ­·å²ç´€éŒ„ä»¥åˆ©æ¯”å°æ™‚é–“æˆ³
          lfs: true # æ”¯æ´å¤§å‹æª”æ¡ˆ (LFS)

      # æ­¥é©Ÿ 2ï¼šè¨­å®š Git èˆ‡ HF é ç«¯é€£ç·š
      - name: ğŸ”§ Configure Git & HF Remote
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }} # å¾ Secret è®€å– Token
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # ä½¿ç”¨åµŒå…¥ Token çš„æ–¹å¼å»ºç«‹ HF é ç«¯
          git remote add hf "https://${{ env.HF_USERNAME }}:${HF_TOKEN}@huggingface.co/spaces/${{ env.HF_SPACE }}"

      # æ­¥é©Ÿ 3ï¼šåŸ·è¡Œé›™å‘åŒæ­¥é‚è¼¯
      - name: ğŸ”„ Bi-directional Sync
        run: |
          echo "ğŸ” æ­£åœ¨æª¢æŸ¥ HF èˆ‡ GitHub çš„æ›´æ–°ç‹€æ³..."
          git fetch hf main # æŠ“å– HF çš„æ›´æ–°è³‡è¨Š
          GITHUB_TIME=$(git log -1 --format=%ct)
          HF_TIME=$(git log -1 --format=%ct hf/main)
          
          # å¦‚æœ HF ä¸Šçš„æäº¤æ™‚é–“è¼ƒæ–°ï¼Œå‰‡å°‡å…¶åˆä½µå› GitHub
          if [ "$HF_TIME" -gt "$GITHUB_TIME" ]; then
            echo "ğŸ“¥ HF æœ‰è¼ƒæ–°çš„è®Šæ›´ï¼ŒåŸ·è¡Œåˆä½µä¸­..."
            git merge hf/main --allow-unrelated-histories --no-edit -m "ğŸ”„ [skip ci] å¾ HF åŒæ­¥æ›´æ–°å…§å®¹"
            git push origin main
          fi
          
          # å°‡æœ€æ–°çš„ç¨‹å¼ç¢¼æ¨é€åˆ° HF
          echo "ğŸ“¤ æ­£åœ¨æ¨é€æ›´æ–°è‡³ Hugging Face..."
          git push hf main --force-with-lease

      # æ­¥é©Ÿ 4ï¼šç›£æ§ HF Space çš„éƒ¨ç½²éšæ®µ
      - name: ğŸš¦ Wait for Deployment
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          API_URL="https://huggingface.co/api/spaces/${{ env.HF_SPACE }}"
          echo "â³ ç›£æ§éƒ¨ç½²ç‹€æ…‹ä¸­..."
          for i in {1..40}; do
            # é€é API ç²å–ç›®å‰çš„ stage ç‹€æ…‹
            STAGE=$(curl -s -H "Authorization: Bearer $HF_TOKEN" "$API_URL/runtime" | python3 -c "import sys,json; print(json.load(sys.stdin).get('stage','UNKNOWN'))")
            echo "å˜—è©¦ $i: ç›®å‰ç‹€æ…‹ = $STAGE"
            # ç•¶ç‹€æ…‹ç‚º RUNNING æˆ–éŒ¯èª¤æ™‚åœæ­¢ç­‰å¾…
            [[ "$STAGE" == "RUNNING" || "$STAGE" == "BUILD_ERROR" || "$STAGE" == "RUNTIME_ERROR" ]] && break
            sleep 15
          done

      # æ­¥é©Ÿ 5ï¼šæŠ“å–ä¸¦æ¸…æ´— SSE æ—¥èªŒæ ¼å¼
      - name: ğŸ“„ Fetch and Clean Logs
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          LOG_DIR="hf_deploy_logs"
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          mkdir -p "$LOG_DIR"
          API_BASE="https://huggingface.co/api/spaces/${{ env.HF_SPACE }}/logs"
          
          # æŠ“å– Build æ—¥èªŒä¸¦éæ¿¾æ‰ SSE çš„ data: å‰ç¶´
          curl -s -N --fail -m 30 -H "Authorization: Bearer $HF_TOKEN" "$API_BASE/build" | sed 's/^data: //g' > "$LOG_DIR/build_$TIMESTAMP.log" || echo "Build log end"
          
          # æŠ“å–åŸ·è¡Œæ—¥èªŒå¿«ç…§ (é™æ™‚ 20 ç§’ä»¥é˜²å¡æ­»)
          curl -s -N --fail -m 20 -H "Authorization: Bearer $HF_TOKEN" "$API_BASE/run" | sed 's/^data: //g' > "$LOG_DIR/run_$TIMESTAMP.log" || echo "Run log snapshot done"

      # æ­¥é©Ÿ 6ï¼šå°‡æ—¥èªŒ Commit å› GitHub
      - name: ğŸ’¾ Archive Logs
        run: |
          git add hf_deploy_logs/
          if ! git diff --cached --quiet; then
            git commit -m "[skip ci] ğŸ“‹ ç´€éŒ„ HF éƒ¨ç½²æ—¥èªŒ ($GITHUB_SHA)"
            git push origin main
          fi

      # æ­¥é©Ÿ 7ï¼šå¯„é€ Email é€šçŸ¥
      - name: ğŸ“§ Send Email Notification
        if: always() # ç¢ºä¿ç„¡è«–å‰é¢çš„æ­¥é©ŸæˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½æœƒåŸ·è¡Œé€™ä¸€æ­¥
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }} # SMTP ä¼ºæœå™¨ (å¦‚ smtp.gmail.com)
          server_port: 465 # ç›´æ¥ä½¿ç”¨ 465 åŸ è™Ÿ (SSL)
          username: ${{ secrets.MAIL_USERNAME }} # å¯„ä»¶å¸³è™Ÿ
          password: ${{ secrets.MAIL_PASSWORD }} # å¯„ä»¶å¯†ç¢¼ (æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼)
          subject: "GitHub Action [${{ github.workflow }}] ç‹€æ…‹: ${{ job.status }}"
          to: ${{ secrets.RECEIVE_EMAIL }} # å¾ Secret è®€å–æ”¶ä»¶äººåœ°å€
          from: GitHub Actions Bot
          body: |
            Hugging Face åŒæ­¥ä»»å‹™å·²å®Œæˆã€‚
            
            â— åŸ·è¡Œçµæœï¼š${{ job.status }}
            â— è§¸ç™¼åˆ†æ”¯ï¼š${{ github.ref_name }}
            â— è§¸ç™¼äººå“¡ï¼š${{ github.actor }}
            
            è©³ç´°åŸ·è¡Œç‹€æ³è«‹åƒé–± GitHub Actions é é¢ï¼š
            https://github.com/${{ github.repository_with_owner }}/actions/runs/${{ github.run_id }}
